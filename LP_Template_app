# streamlit_app.py
import streamlit as st
from docx import Document
import json
import os

def main():
    # Page configuration
    st.set_page_config(page_title="5-Day AI Lesson Plan Generator", layout="wide")
    st.title("5-Day AI Lesson Plan Generator")

    st.write("""
    Upload your AI-generated JSON file containing the lesson plan data.
    This app will populate the WLPT Word template with your content, preserving
    logos and table formatting.
    """)

    # Upload JSON file from user
    uploaded_file = st.file_uploader("Upload AI JSON output", type="json")

    if uploaded_file:
        try:
            # Load JSON content
            lesson_plan_json = json.load(uploaded_file)

            # Ensure templates folder exists
            template_path = os.path.join("templates", "WLPT.docx")
            if not os.path.exists(template_path):
                st.error("Template file WLPT.docx not found in templates folder!")
                return

            # Load the Word template
            template_doc = Document(template_path)

            # Replace placeholders in all tables
            for table in template_doc.tables:
                for row in table.rows:
                    for cell in row.cells:
                        for key, value in lesson_plan_json.items():
                            placeholder = f"{{{{{key}}}}}"  # e.g., {{Class1_LearningObjective}}
                            if placeholder in cell.text:
                                cell.text = cell.text.replace(placeholder, value)

            # Save the populated lesson plan
            output_path = "LessonPlan_Filled.docx"
            template_doc.save(output_path)

            st.success("Lesson plan generated successfully!")

            # Provide download button
            with open(output_path, "rb") as f:
                st.download_button(
                    label="Download Populated Lesson Plan",
                    data=f,
                    file_name="LessonPlan_Filled.docx",
                    mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                )

        except Exception as e:
            st.error(f"Error processing file: {e}")
    else:
        st.info("Please upload your AI-generated JSON file to populate the template.")

# Main guard to ensure Streamlit runs correctly
if __name__ == "__main__":
    main()
